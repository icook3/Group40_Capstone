<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zlow: Browser Cycling Simulator</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="../../resources/components/aframe_tube_geometry/index.js"></script>
    <script src="../../resources/components/aframe_curve_follow/index.js"></script>
    <script src="../../resources/components/aframe_parametric_curve/index.js" type="module"></script>
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/style.css?version=1.0"
    />
    <link rel="stylesheet" href="../css/hud.css" />

    <link rel="stylesheet" href="../css/hud.css" />
    <link rel="stylesheet" href="../css/workoutSummary.css" />

    <link
      rel="icon"
      type="image/svg+xml"
      href="../../resources/favicons/ZlowFavicon.svg"
    />
    <style>
      /* Trainer Calibration Modal Styles */
      #calibration-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      #calibration-modal.show {
        display: flex;
      }

      .calibration-modal-content {
        background: white;
        border-radius: 10px;
        padding: 40px;
        max-width: 600px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-height: 90vh;
        overflow-y: auto;
      }

      .calibration-modal-content h2 {
        color: #333;
        margin-top: 0;
        font-size: 1.8em;
      }

      .calibration-status {
        font-size: 1.2em;
        color: #666;
        margin: 20px 0;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .status-connected {
        color: #27ae60;
        font-weight: bold;
      }

      .status-error {
        color: #e74c3c;
        font-weight: bold;
      }

      .status-in-progress {
        color: #f39c12;
        font-weight: bold;
      }

      .calibration-steps {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
      }

      .calibration-steps h3 {
        margin-top: 0;
        color: #333;
      }

      .step {
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-left: 4px solid #3498db;
        border-radius: 4px;
      }

      .step.completed {
        border-left-color: #27ae60;
        background: #f0fdf4;
      }

      .step.active {
        border-left-color: #f39c12;
        background: #fffbf0;
      }

      .step-title {
        font-weight: bold;
        color: #333;
      }

      .step-description {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }

      .calibration-button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      /* Override hud-btn styling for modal context */
      .calibration-button-group .hud-btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid #3498db;
      }

      .calibration-button-group .hud-btn:hover:not(:disabled) {
        background: #2980b9;
        border-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .calibration-button-group .hud-btn:disabled {
        background: #95a5a6;
        border-color: #95a5a6;
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Specific button colors */
      #calibration-skip-btn {
        background: #95a5a6 !important;
        border-color: #95a5a6 !important;
      }

      #calibration-skip-btn:hover:not(:disabled) {
        background: #7f8c8d !important;
        border-color: #7f8c8d !important;
      }

      #calibration-close-btn {
        background: #e74c3c !important;
        border-color: #e74c3c !important;
      }

      #calibration-close-btn:hover:not(:disabled) {
        background: #c0392b !important;
        border-color: #c0392b !important;
      }

      .calibration-data-display {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        font-family: monospace;
        color: #333;
      }

      .data-item {
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
      }

      .data-label {
        font-weight: bold;
        color: #555;
      }

      .data-value {
        color: #27ae60;
      }
    </style>
  </head>
  <body>
    <div id="hud-top">
      <div class="hud-section left">
        <div class="stat-item">
          <span id="time" class="stat-value">00:00</span>
        </div>
      </div>

      <div class="hud-section center">
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-value-group">
              <span id="speed" class="stat-value">0</span>
              <span class="stat-unit speed-unit">km/h</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-value-group">
              <span id="power" class="stat-value">0</span>
              <span class="stat-unit power-unit">W</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-value-group">
              <span id="distance" class="stat-value">0.00</span>
              <span class="stat-unit distance-unit">km</span>
            </div>
          </div>
        </div>
      </div>

      <div class="hud-section right">
        <div class="stat-item">
          <div class="stat-value-group">
            <span id="calories" class="stat-value">0</span>
            <span class="stat-unit">kcal</span>
          </div>
        </div>
      </div>
    </div>

    <div id="hud-bottom">
      <div class="control-buttons">
        <button
          id="menu-btn"
          class="hud-btn"
          onclick="window.location.href='./mainMenu.html'"
        >
          Main Menu
        </button>
        <button id="pacer-sync-btn" class="hud-btn">Sync Pacer</button>
        <button id="calibrate-trainer-modal-btn" class="hud-btn">Calibrate Trainer</button>
        <button id="connect-btn">Connect Trainer</button>
        <button id="pause-btn" class="hud-btn">Pause</button>
        <button id="stop-btn" class="hud-btn">Stop</button>
      </div>
    </div>

    <!-- Dev hud - hidden by default -->
    <div id="dev-controls-hud" hidden>
      <span id="pacer">
        <label for="pacer-speed">Pacer:</label>
        <input
          id="pacer-speed"
          type="number"
          min="5"
          max="60"
          value="20"
          step="1"
        />
        <span class="speed-unit">km/h</span>
      </span>

      <span id="weight">
        <label for="rider-weight">Weight:</label>
        <input
          id="rider-weight"
          type="number"
          min="40"
          max="150"
          value="70"
          step="1"
        />
        <span class="weight-unit">kg</span>
      </span>

      <button id="calories-reset-btn">Reset Calories</button>
    </div>

    <!-- Pause overlay -->
    <div id="pause-overlay" aria-hidden="true">
      <div class="pause-dialog">
        Resuming in <span id="pause-countdown">10</span>…
      </div>
    </div>

<<<<<<< HEAD
    <!-- Trainer Calibration Modal -->
    <div id="calibration-modal" aria-hidden="true">
      <div class="calibration-modal-content">
        <h2>Trainer Calibration</h2>

        <div class="calibration-status" id="calibration-status-display">
          Ready to calibrate
        </div>

        <div class="calibration-steps">
          <h3>Calibration Process</h3>
          <div id="calibration-step-1" class="step active">
            <div class="step-title">1. Connect Trainer</div>
            <div class="step-description">
              Search for and connect to your Bluetooth trainer device
            </div>
          </div>
          <div id="calibration-step-2" class="step">
            <div class="step-title">2. Spin-Down Calibration</div>
            <div class="step-description">
              Pedal at steady power, then stop and let trainer coast to measure resistance
            </div>
          </div>
          <div id="calibration-step-3" class="step">
            <div class="step-title">3. Zero Offset</div>
            <div class="step-description">
              Calibrate power meter zero offset
            </div>
          </div>
          <div id="calibration-step-4" class="step">
            <div class="step-title">4. Complete</div>
            <div class="step-description">
              Calibration successful - ready to ride
            </div>
          </div>
        </div>

        <div class="calibration-data-display" id="calibration-data-display" style="display: none;">
          <div class="data-item">
            <span class="data-label">Power (W):</span>
            <span class="data-value" id="calibration-power-value">—</span>
          </div>
          <div class="data-item">
            <span class="data-label">Calibration State:</span>
            <span class="data-value" id="calibration-state-value">—</span>
          </div>
          <div class="data-item">
            <span class="data-label">Last Event:</span>
            <span class="data-value" id="calibration-last-event">—</span>
          </div>
        </div>

        <div class="calibration-button-group">
          <button id="calibration-connect-trainer-btn" class="hud-btn">
            Connect Trainer
          </button>
          <button id="calibration-start-btn" class="hud-btn" disabled>
            Start Calibration
          </button>
          <button id="calibration-skip-btn" class="hud-btn" style="background: #95a5a6;">
            Skip Calibration
          </button>
          <button id="calibration-close-btn" class="hud-btn" style="background: #e74c3c;">
            Close
          </button>
        </div>
=======
    <!-- Workout overlay -->
    <div id="workout-overlay" aria-hidden="true">
      <div class="workout-dialog">
        Starting in <span id="workout-countdown">10</span>…
>>>>>>> main
      </div>
    </div>

    <!-- Generate starting scene -->
    <a-scene id="scene">
      <a-assets>
        <!-- Add textures used to create the track and grass -->
        <img id="track-texture" src="../../resources/textures/Track.jpeg" />
        <img id="grass-texture" src="../../resources/textures/Grass.jpeg" />

        <!-- Building models -->
        <a-asset-item
          id="house-obj"
          src="../../resources/models/bgmodels/House.glb"
        ></a-asset-item>
        <a-asset-item
          id="tall-building-obj"
          src="../../resources/models/bgmodels/TallBuilding.glb"
        ></a-asset-item>
        <a-asset-item
          id="wide-building-obj"
          src="../../resources/models/bgmodels/WideBuilding.glb"
        ></a-asset-item>

        <!-- Add playermodel assets -->
        <a-asset-item
          id="bikeGLB"
          src="../../resources/models/playermodels/bikeV4.glb"
        ></a-asset-item>
        <a-asset-item
          id="maleGLB"
          src="../../resources/models/playermodels/maleV5.glb"
        ></a-asset-item>
        <a-asset-item
          id="femaleGLB"
          src="../../resources/models/playermodels/femaleV6.glb"
        ></a-asset-item>

        <!-- Add cloud assets -->
        <a-asset-item
          id="cloud1"
          src="../../resources/models/bgmodels/cloud1.glb"
        ></a-asset-item>
        <a-asset-item
          id="cloud2"
          src="../../resources/models/bgmodels/cloud2.glb"
        ></a-asset-item>
        <a-asset-item
          id="cloud3"
          src="../../resources/models/bgmodels/cloud3.glb"
        ></a-asset-item>

        <!-- Add tree assets -->
        <a-asset-item
          id="tree1"
          src="../../resources/models/bgmodels/tree1.glb"
        ></a-asset-item>
        <a-asset-item
          id="tree2"
          src="../../resources/models/bgmodels/tree2.glb"
        ></a-asset-item>
        <a-asset-item
          id="tree3"
          src="../../resources/models/bgmodels/tree3.glb"
        ></a-asset-item>
        <a-asset-item
          id="tree-bush1"
          src="../../resources/models/bgmodels/bush1.glb"
        ></a-asset-item>
      </a-assets>
      <a-sky color="#87ceeb"></a-sky>

      <!-- Checkerboard ground: green and brown tiles, covers the whole visible area -->
      <a-entity id="checkerboard-ground">
        <a-entity id="tiles"></a-entity>
      </a-entity>

      <!-- Get values for scene and tilesEntity before using a module to import constants -->
      <script>
        const scene = document.currentScript.parentElement;
        // Add as a new thing rather than getting the entity??
        const tilesEntity = scene.querySelector("#tiles");
      </script>

      <!-- Buildings, trees, clouds, and path are generated dynamically in scene.js and will not overlap the center column -->
      <!-- Use constants to generate checkerboard tiles for ground dynamically -->
      <script type="module">
        import { constants } from "../js/constants.js";
        for (let x = 0; x < constants.gridWidth; x++) {
          for (let z = 0; z < constants.gridDepth; z++) {
            const color =
              (x + z) % 2 === 0
                ? constants.groundColor1
                : constants.groundColor2;
            const tile = document.createElement("a-entity");
            tile.setAttribute(
              "geometry",
              `primitive: box; width: ${constants.tileSize}; height: ${constants.height}; depth: ${constants.tileSize}`
            );
            //tile.setAttribute('material', `color: ${color}; roughness: ${constants.roughness}; metalness: ${constants.metalness}`);
            tile.setAttribute("material", "src: #grass-texture");
            tile.setAttribute(
              "position",
              `${constants.startX + x * constants.tileSize} 0 ${
                constants.startZ - z * constants.tileSize
              }`
            );
            tilesEntity.appendChild(tile);
          }
        }
      </script>

      <a-entity id="rig" position="0 4.5 5">
        <a-entity id="camera" camera zoom="1" look-controls></a-entity>
      </a-entity>
    </a-scene>

    <script type="module" src="../js/main.js"></script>
    <script type="module" src="../js/trainerCalibration.js"></script>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        if (window.initZlowApp) window.initZlowApp();
      });
    </script>
    <script type="module">
      import { NotificationManager } from "../js/notifications.js";
      window.testNotifications = new NotificationManager();
    </script>
  </body>
</html>
