<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zlow: Browser Cycling Simulator</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <link rel="icon" type="image/svg+xml" href="../../resources/favicons/ZlowFavicon.svg">
    <link rel="stylesheet" href="../css/playerCustomization.css" />
    <style>
        body {
            background-color: grey;
        }
    </style>
</head>
<body>
<!-- Avatar -->
<a-scene id="mainMenuScene" embedded
         style="width: 33%; height: 100%; background: transparent;">
    <a-entity camera position="0 1.5 3" look-controls="enabled: false"></a-entity>
    <a-assets>
        <a-asset-item id="bikeGLB" src="../../resources/models/playermodels/bikeV4.glb"></a-asset-item>
        <a-asset-item id="maleGLB" src="../../resources/models/playermodels/maleV5.glb"></a-asset-item>
        <a-asset-item id="femaleGLB" src="../../resources/models/playermodels/femaleV6.glb"></a-asset-item>
    </a-assets>
</a-scene>
<script type="module">
    import { AvatarCreator } from '../js/avatarCreator.js';

    window.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('#mainMenuScene');
        if (!scene) {
            console.error("Scene not found!");
            return;
        }

        //Create the avatar immediately
        const avatar = new AvatarCreator(
            "menuAvatar",
            { x: 0, y: 0, z: -1 },
            { x: 0, y: 90, z: 0 },
            (avatarInstance) => {
                avatarInstance.setMenuPosition();
                avatarInstance.enableMenuRotation();
                avatarInstance.startRotationLoop();

                window.avatarInstance = avatarInstance;
            }
        );
    });
</script>

<!-- Color Picker -->
<script>
    const colorPicker = document.getElementById('colorPicker');
</script>

<!-- Model Picker -->
<script>
    window.addEventListener("DOMContentLoaded", () => {
        const models = ["Male", "Female"];


        const genderLabel = document.getElementById("genderLabel");
        const leftArrow = document.getElementById("leftArrow");
        const rightArrow = document.getElementById("rightArrow");

        //Wait until avatarInstance exists
        function initGenderLabel() {
            if (!window.avatarInstance) {
                requestAnimationFrame(initGenderLabel);
                return;
            }

            const savedModel = window.avatarInstance.playerModel || "male";
            let currentModelIndex = savedModel.toLowerCase() === "female" ? 1 : 0;
            genderLabel.textContent = models[currentModelIndex];

            function updateGenderDisplay() {
                genderLabel.textContent = models[currentModelIndex];
                window.avatarInstance.setPlayerModel(models[currentModelIndex].toLowerCase());
            }

            leftArrow.addEventListener("click", () => {
                currentModelIndex = (currentModelIndex - 1 + models.length) % models.length;
                updateGenderDisplay();
            });

            rightArrow.addEventListener("click", () => {
                currentModelIndex = (currentModelIndex + 1) % models.length;
                updateGenderDisplay();
            });
        }

        initGenderLabel();
    });
</script>

<!-- Player Colors -->
<script>
    window.addEventListener("DOMContentLoaded", () => {
        //Wait until avatarInstance exists
        function initPlayerColors() {
            if (!window.avatarInstance) {
                requestAnimationFrame(initPlayerColors);
                return;
            }

            const colorPickers = document.querySelectorAll('#playerControls .color-picker');

            colorPickers.forEach(picker => {
                picker.addEventListener('input', (e) => {
                    const mat = picker.dataset.mat; // Skin, Shirt, Shorts, Shoes
                    const color = e.target.value;

                    //Get current colors
                    const avatar = window.avatarInstance;
                    let skin = avatar.skinColor;
                    let shirt = avatar.shirtColor;
                    let shorts = avatar.shortsColor;
                    let shoes = avatar.shoesColor;

                    //Update only the changed one
                    switch (mat) {
                        case "Skin":
                            skin = color;
                            break;
                        case "Shirt":
                            shirt = color;
                            break;
                        case "Shorts":
                            shorts = color;
                            break;
                        case "Shoes":
                            shoes = color;
                            break;
                    }

                    //Apply all colors
                    avatar.setPlayerColors(skin, shirt, shorts, shoes);
                });
            });
        }

        initPlayerColors();
    });
</script>

<!-- Bike Colors -->
<script>
    window.addEventListener("DOMContentLoaded", () => {
        function initBikeColors() {
            if (!window.avatarInstance) {
                requestAnimationFrame(initBikeColors);
                return;
            }

            const colorPickers = document.querySelectorAll('#bikeControls .color-picker');

            colorPickers.forEach(picker => {
                picker.addEventListener('input', (e) => {
                    const mat = picker.dataset.mat; // Frame_Mat, Tire_Mat, Grip_Mat, etc.
                    const color = e.target.value;

                    const avatar = window.avatarInstance;

                    //Get current bike colors
                    let frame = avatar.bikeFrameColor;
                    let tires = avatar.bikeTireColor;
                    let grip = avatar.bikeGripColor;
                    let seat = avatar.bikeSeatColor;
                    let pedals = avatar.bikePedalColor;
                    let pedalCrank = avatar.bikeCrankColor;

                    //Update only the changed one
                    switch(mat) {
                        case "Frame_Mat":
                            frame = color;
                            break;
                        case "Tire_Mat":
                            tires = color;
                            break;
                        case "Grip_Mat":
                            grip = color;
                            break;
                        case "Seat_Mat":
                            seat = color;
                            break;
                        case "Pedal_Mat":
                            pedals = color;
                            break;
                        case "PedalCrank_Mat":
                            pedalCrank = color;
                            break;
                    }

                    //Apply all bike colors
                    avatar.setBikeColors(frame, tires, grip, seat, pedals, pedalCrank);
                });
            });
        }

        initBikeColors();
    });
</script>

<script>
    function setInitialPickerValues() {
        if (!window.avatarInstance) {
            requestAnimationFrame(setInitialPickerValues);
            return;
        }

        const avatar = window.avatarInstance;

        document.querySelector('#playerControls .color-picker[data-mat="Skin"]').value = avatar.skinColor;
        document.querySelector('#playerControls .color-picker[data-mat="Shirt"]').value = avatar.shirtColor;
        document.querySelector('#playerControls .color-picker[data-mat="Shorts"]').value = avatar.shortsColor;
        document.querySelector('#playerControls .color-picker[data-mat="Shoes"]').value = avatar.shoesColor;

        document.querySelector('#bikeControls .color-picker[data-mat="Frame_Mat"]').value = avatar.bikeFrameColor;
        document.querySelector('#bikeControls .color-picker[data-mat="Tire_Mat"]').value = avatar.bikeTireColor;
        document.querySelector('#bikeControls .color-picker[data-mat="Grip_Mat"]').value = avatar.bikeGripColor;
        document.querySelector('#bikeControls .color-picker[data-mat="Seat_Mat"]').value = avatar.bikeSeatColor;
        document.querySelector('#bikeControls .color-picker[data-mat="Pedal_Mat"]').value = avatar.bikePedalColor;
        document.querySelector('#bikeControls .color-picker[data-mat="PedalCrank_Mat"]').value = avatar.bikeCrankColor;
    }

    setInitialPickerValues();
</script>

<!-- Person Color Buttons -->
<div id="playerContainer">
    <h2>Player Customization</h2>
    <div id="playerControls">
        <div id="genderSelector">
            <button class="arrow-btn" id="leftArrow">⮜</button>
            <span id="genderLabel">Male</span>
            <button class="arrow-btn" id="rightArrow">⮞</button>
        </div>
        <div class="option">
            <label>Skin<input type="color" class="color-picker" data-mat="Skin" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Shirt<input type="color" class="color-picker" data-mat="Shirt" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Shorts<input type="color" class="color-picker" data-mat="Shorts" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Shoes<input type="color" class="color-picker" data-mat="Shoes" value="#ff0000"></label>
        </div>
    </div>
</div>

<!-- Bike Color Buttons -->
<div id="bikeContainer">
    <h2>Bike Customization</h2>
    <div id="bikeControls">
        <div class="option">
            <label>Frame<input type="color" class="color-picker" data-mat="Frame_Mat" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Tires<input type="color" class="color-picker" data-mat="Tire_Mat" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Grip<input type="color" class="color-picker" data-mat="Grip_Mat" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Seat<input type="color" class="color-picker" data-mat="Seat_Mat" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Pedals<input type="color" class="color-picker" data-mat="Pedal_Mat" value="#ff0000"></label>
        </div>
        <div class="option">
            <label>Pedal Crank<input type="color" class="color-picker" data-mat="PedalCrank_Mat" value="#ff0000"></label>
        </div>
    </div>
</div>

<!-- Save Button -->
<div id = "menu">
    <button id="menuButton" onclick="window.location.href='./mainMenu.html'">Main Menu</button>
</div>

</body>
</html>